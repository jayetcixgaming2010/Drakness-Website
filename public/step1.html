<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drakness HUB - Step 1</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .title1,.title2{position:fixed;left:20px;z-index:2;margin:0;text-transform:uppercase;letter-spacing:.18em;font-weight:800}
    .title1{top:18px;font-size:14px;color:rgba(255,255,255,.92)}
    .title2{top:46px;font-size:12px;color:var(--muted);letter-spacing:.22em}
    .box{position:relative;z-index:1;width:min(520px,100%);border:1px solid var(--line);border-radius:var(--r);padding:18px;background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.02));box-shadow:var(--shadow);overflow:hidden;text-align:left}
    .box::after{content:"";position:absolute;inset:-2px;background:radial-gradient(520px 240px at 15% 20%,rgba(255,255,255,.12),transparent 55%),radial-gradient(420px 220px at 80% 35%,rgba(255,255,255,.10),transparent 60%);opacity:.55;pointer-events:none;filter:blur(2px)}
    .box>*{position:relative;z-index:1}
    .item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border:1px solid rgba(255,255,255,.14);margin-bottom:12px;border-radius:14px;cursor:pointer;background:rgba(0,0,0,.18);transition:transform .12s,background .12s,border-color .12s;user-select:none;font-size:14px;color:rgba(255,255,255,.86);letter-spacing:.01em}
    .item:hover{transform:translateY(-1px);background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.24)}
    [id^="status"]{display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:24px;font-family:ui-monospace,monospace;color:rgba(255,255,255,.85)}
    .spinner{border:3px solid rgba(255,255,255,.18);border-top:3px solid rgba(255,255,255,.92);border-radius:999px;width:18px;height:18px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    #finalBtn{margin-top:14px;text-align:center;padding:12px 14px;border-radius:14px;font-weight:800;letter-spacing:.18em;text-transform:uppercase;user-select:none;font-size:14px}
    .locked{border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.55);background:rgba(255,255,255,.04);cursor:not-allowed}
    .unlocked{border:1px solid rgba(255,255,255,.34);background:rgba(255,255,255,.12);color:rgba(255,255,255,.92);cursor:pointer;box-shadow:0 0 18px rgba(255,255,255,.12);transition:transform .12s,background .12s,border-color .12s}
    .unlocked:hover{transform:translateY(-1px);background:rgba(255,255,255,.16);border-color:rgba(255,255,255,.46)}
    #api-status{margin-top:10px;text-align:center;font-size:12px;color:rgba(255,255,255,.55);letter-spacing:.02em;min-height:16px}
  </style>
</head>
<body>
  <h1 class="title1">Drakness HUB</h1>
  <h2 class="title2">Step 1</h2>

  <script>
    // üî• DOMAIN TH·∫¨T C·ª¶A B·∫†N
    const API = "https://drakness.netlify.app/.netlify/functions/api";
    const hwid = localStorage.getItem("hwid");

    if (!hwid) {
      showBlockNotification();
    } else {
      initPage();
    }

    function initPage() {
      const box = document.createElement("div");
      box.className = "box";
      box.id = "box";
      document.body.appendChild(box);

      let links = {};
      let completed = [];

      // Fetch file JSON t·ª´ th∆∞ m·ª•c public (kh√¥ng c·∫ßn /data/)
      fetch("/ytb.json")
        .then(r => {
          if (!r.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch video");
          return r.json();
        })
        .then(data => {
          links = data;
          const total = Object.keys(links).length;
          completed = new Array(total).fill(false);

          for (let i = 1; i <= total; i++) {
            const item = document.createElement("div");
            item.className = "item";
            item.id = `task${i}`;
            item.innerHTML = `<span>Like + Comment Video ${i}</span><span id="status${i}"></span>`;
            item.onclick = () => startTask(i);
            box.appendChild(item);
          }

          const finalBtn = document.createElement("div");
          finalBtn.className = "locked";
          finalBtn.id = "finalBtn";
          finalBtn.innerText = "LOCK";
          box.appendChild(finalBtn);

          const apiStatus = document.createElement("div");
          apiStatus.id = "api-status";
          box.appendChild(apiStatus);
        })
        .catch(error => {
          console.error("L·ªói fetch ytb.json:", error);
          createMockData();
        });
    }

    function createMockData() {
      const box = document.getElementById("box");
      if (!box) return;
      
      links = {
        "link1": "https://youtu.be/kHiw-9XpZqk",
        "link2": "https://youtu.be/3t5hw9dJJEc"
      };
      const total = 2;
      completed = new Array(total).fill(false);

      for (let i = 1; i <= total; i++) {
        const item = document.createElement("div");
        item.className = "item";
        item.id = `task${i}`;
        item.innerHTML = `<span>Like + Comment Video ${i}</span><span id="status${i}"></span>`;
        item.onclick = () => startTask(i);
        box.appendChild(item);
      }

      const finalBtn = document.createElement("div");
      finalBtn.className = "locked";
      finalBtn.id = "finalBtn";
      finalBtn.innerText = "LOCK";
      box.appendChild(finalBtn);

      const apiStatus = document.createElement("div");
      apiStatus.id = "api-status";
      box.appendChild(apiStatus);
    }

    function startTask(id) {
      const status = document.getElementById(`status${id}`);
      status.innerHTML = '<div class="spinner"></div>';

      const linkKey = `link${id}`;
      if (!links[linkKey]) { 
        status.innerHTML = "‚úó"; 
        return; 
      }

      window.open(links[linkKey], "_blank");

      setTimeout(() => {
        status.innerHTML = "‚úî";
        completed[id - 1] = true;
        checkUnlock();
      }, 5000);
    }

    function checkUnlock() {
      if (!completed.every(x => x)) return;

      const btn = document.getElementById("finalBtn");
      btn.innerText = "UNLOCK";
      btn.classList.add("unlocked");
      btn.classList.remove("locked");
      btn.onclick = callStep1Api;
    }

    async function callStep1Api() {
      const btn = document.getElementById("finalBtn");
      const apiStatus = document.getElementById("api-status");

      btn.style.pointerEvents = "none";
      btn.innerText = "ƒêang x·ª≠ l√Ω...";
      apiStatus.textContent = "ƒêang g·ªçi API...";

      try {
        const res = await fetch(`${API}/step1`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hwid: hwid })
        });
        
        const data = await res.json();

        if (data.success) {
          apiStatus.textContent = "‚úî Step 1 ho√†n th√†nh!";
          setTimeout(() => {
            window.location.href = "https://direct-link.net/1213408/ntt-hub1";
          }, 500);
        } else {
          btn.style.pointerEvents = "auto";
          btn.innerText = "UNLOCK";
          apiStatus.textContent = "L·ªói: " + (data.error || "unknown");
        }
      } catch (e) {
        console.error("L·ªói fetch:", e);
        btn.style.pointerEvents = "auto";
        btn.innerText = "UNLOCK";
        apiStatus.textContent = "L·ªói k·∫øt n·ªëi API. Th·ª≠ l·∫°i.";
      }
    }

    function showBlockNotification() {
      const overlay = document.createElement("div");
      Object.assign(overlay.style, { position:"fixed", inset:"0", backgroundColor:"rgba(0,0,0,0.85)", zIndex:"9998" });
      document.body.appendChild(overlay);

      const noti = document.createElement("div");
      Object.assign(noti.style, { position:"fixed", top:"50%", left:"50%", transform:"translate(-50%,-50%)", background:"#111", padding:"25px 35px", border:"2px solid white", borderRadius:"12px", color:"white", fontFamily:"Arial", zIndex:"9999", width:"350px", textAlign:"center", boxShadow:"0 0 20px rgba(255,255,255,0.3)" });
      noti.innerHTML = `
        <h2 style="margin-top:0;">Notification</h2>
        <p style="font-size:16px;line-height:1.5;">
          B·∫°n ch∆∞a c√≥ HWID<br><br>
          Vui l√≤ng d√πng ƒë√∫ng URL:<br><br>
          <b>https://drakness.netlify.app/?hwid=YOUR_HWID</b>
        </p>
      `;
      document.body.appendChild(noti);
    }
  </script>
</body>
</html>