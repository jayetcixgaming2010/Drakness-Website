<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drakness HUB - KEY SYSTEM</title>
  <link rel="icon" type="image/png" href="/Logo/1750522984859.png" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"><img src="/Logo/1750522984859.png" alt="Logo" /></div>
        <div class="brand-title">
          <p class="name">Drakness HUB</p>
          <p class="sub">Key System</p>
        </div>
      </div>
      <div class="pill">Get Key</div>
    </header>

    <main>
      <section class="card">
        <div class="inner">
          <div class="kicker"><span class="dot"></span>Key System</div>
          <h1 class="title">Get Your Key</h1>
          <p class="desc">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫≠n key. B·∫°n s·∫Ω tr·∫£i qua 3 b∆∞·ªõc nhanh g·ªçn.</p>

          <div class="grid">
            <div class="box">
              <h2>Get Key</h2>
              <button class="btn primary" id="btnGetKey" onclick="startGetKey()">Get Key</button>
            </div>
            <div class="box">
              <h2>Discord</h2>
              <button class="btn" onclick="window.open('https://discord.gg/sEs7HvCXJF','_blank')">Join Discord</button>
            </div>
          </div>

          <div id="status-msg" class="status-message"></div>
          
          <div id="key-status" class="key-status" style="display: none;"></div>

          <footer>
            <div>¬© <span id="y"></span> Drakness HUB</div>
            <a class="link" href="https://discord.gg/sEs7HvCXJF" target="_blank">discord.gg/sEs7HvCXJF</a>
          </footer>
        </div>
      </section>
    </main>
  </div>

  <script>
    document.getElementById("y").textContent = new Date().getFullYear();

    // üî• QUAN TR·ªåNG: THAY B·∫∞NG DOMAIN TH·∫¨T C·ª¶A B·∫†N
    const API = "https://drakness.netlify.app/.netlify/functions/api";

    // L·∫•y hwid t·ª´ URL param
    const urlParams = new URLSearchParams(window.location.search);
    const hwid = urlParams.get("hwid");

    if (hwid) {
      localStorage.setItem("hwid", hwid);
    }

    const storedHwid = localStorage.getItem("hwid");

    // Ki·ªÉm tra n·∫øu c√≥ HWID th√¨ ki·ªÉm tra tr·∫°ng th√°i key hi·ªán t·∫°i
    if (storedHwid) {
      checkUserKeyStatus();
    }

    async function checkUserKeyStatus() {
      try {
        const res = await fetch(`${API}/user-status/${encodeURIComponent(storedHwid)}`);
        const data = await res.json();
        
        if (data.success && data.hasValidKey) {
          const keyStatus = document.getElementById("key-status");
          const expiryDate = new Date(data.keyInfo.expiresAt);
          const now = new Date();
          const hoursLeft = Math.floor((expiryDate - now) / (1000 * 60 * 60));
          
          keyStatus.style.display = "block";
          keyStatus.innerHTML = `
            <div class="key-info">
              <p>‚úÖ B·∫°n ƒë√£ c√≥ key h·ª£p l·ªá!</p>
              <p>Key: <strong>${data.keyInfo.key}</strong></p>
              <p>C√≤n h·∫°n: <strong>${hoursLeft} gi·ªù</strong></p>
              <button class="btn small" onclick="window.location.href='key.html'">Xem Key</button>
            </div>
          `;
        }
      } catch (error) {
        console.error("L·ªói ki·ªÉm tra key:", error);
      }
    }

    async function startGetKey() {
      // üî• S·ª¨A L·ªñI: Ki·ªÉm tra HWID ngay trong h√†m n√†y
      const currentHwid = localStorage.getItem("hwid");
      if (!currentHwid) {
        showBlockNotification();
        return;
      }

      const btn = document.getElementById("btnGetKey");
      const msg = document.getElementById("status-msg");

      btn.disabled = true;
      btn.textContent = "ƒêang kh·ªüi t·∫°o...";
      msg.textContent = "";
      msg.className = "status-message";

      try {
        const checkRes = await fetch(`${API}/user-status/${encodeURIComponent(currentHwid)}`);
        const checkData = await checkRes.json();
        
        if (checkData.success && checkData.hasValidKey) {
          msg.textContent = "‚úî B·∫°n ƒë√£ c√≥ key, ƒëang chuy·ªÉn ƒë·∫øn trang key...";
          msg.className = "status-message success";
          setTimeout(() => {
            window.location.href = "key.html";
          }, 1000);
          return;
        }

        if (checkData.success) {
          if (checkData.steps.step1 && checkData.steps.step2 && !checkData.steps.step3) {
            msg.textContent = "‚è≥ B·∫°n ƒë√£ ho√†n th√†nh Step 2, ƒëang chuy·ªÉn ti·∫øp...";
            setTimeout(() => {
              window.location.href = "step3.html";
            }, 1000);
            return;
          } else if (checkData.steps.step1 && !checkData.steps.step2) {
            msg.textContent = "‚è≥ B·∫°n ƒë√£ ho√†n th√†nh Step 1, ƒëang chuy·ªÉn ti·∫øp...";
            setTimeout(() => {
              window.location.href = "step2.html";
            }, 1000);
            return;
          }
        }

        msg.textContent = "‚úî ƒêang chuy·ªÉn ƒë·∫øn b∆∞·ªõc 1...";
        msg.className = "status-message success";
        setTimeout(() => {
          window.location.href = "step1.html";
        }, 600);
        
      } catch (error) {
        console.error("L·ªói:", error);
        btn.disabled = false;
        btn.textContent = "Get Key";
        msg.textContent = "Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server. Th·ª≠ l·∫°i.";
        msg.className = "status-message error";
      }
    }

    function showBlockNotification() {
      const overlay = document.createElement("div");
      Object.assign(overlay.style, { position:"fixed", inset:"0", backgroundColor:"rgba(0,0,0,0.85)", zIndex:"9998" });
      document.body.appendChild(overlay);

      const noti = document.createElement("div");
      Object.assign(noti.style, { position:"fixed", top:"50%", left:"50%", transform:"translate(-50%,-50%)", background:"#111", padding:"28px 36px", border:"1.5px solid rgba(255,255,255,0.3)", borderRadius:"16px", color:"white", fontFamily:"ui-sans-serif,sans-serif", zIndex:"9999", width:"360px", textAlign:"center", boxShadow:"0 0 40px rgba(255,255,255,0.1)" });
      noti.innerHTML = `
        <h2 style="margin-top:0;font-size:16px;letter-spacing:.1em;text-transform:uppercase;">Notification</h2>
        <p style="font-size:14px;line-height:1.7;color:rgba(255,255,255,.78);">
          B·∫°n ch∆∞a c√≥ HWID.<br><br>
          Vui l√≤ng d√πng ƒë√∫ng URL:<br><br>
          <b style="color:white;word-break:break-all;">https://drakness.netlify.app/?hwid=YOUR_HWID</b>
        </p>
      `;
      document.body.appendChild(noti);
      
      document.getElementById("btnGetKey").disabled = true;
    }
  </script>
</body>
</html>